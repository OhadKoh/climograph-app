<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 拽专祝 砖</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #fff;
            color: #333;
            margin: 0;
            padding: 5px;
            text-align: center;
        }
        
        body.clean-mode .editor-only { display: none !important; }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 10px;
        }

        /* --- 转专转 --- */
        .header-section input {
            font-size: 22px;
            padding: 5px;
            width: 90%;
            border: none;
            border-bottom: 2px solid #3498db;
            text-align: center;
            font-weight: bold;
            background: transparent;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        body.clean-mode .header-section input { border-bottom: none; pointer-events: none; }
        .subtitle { font-size: 15px; color: #555; font-weight: bold; margin-bottom: 10px; }

        /* --- 专 专驻 --- */
        .charts-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px; 
            margin-top: 10px;
        }
        .chart-box {
            flex: 1;
            min-width: 380px; 
            max-width: 600px;
        }
        .chart-wrapper {
            position: relative;
            height: 450px; 
            width: 100%;
            border: 1px solid transparent; 
        }

        /* --- 转 注专 --- */
        .tables-container {
            display: block; 
            margin-top: 30px;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
        .table-box { 
            margin-bottom: 40px; 
            background: #fdfdfd;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            direction: ltr; 
        }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #eee; font-weight: bold; }
        
        td input { 
            width: 100%; 
            border: none; 
            background: transparent; 
            text-align: center; 
            font-size: 15px; 
            padding: 5px 0;
        }
        td input:focus { background-color: #e8f0fe; outline: none; font-weight: bold;}

        /* --- 住专  --- */
        .controls-bar {
            background: #f4f6f7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        
        button.action-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        button.action-btn:hover { background-color: #219150; }

        .axis-input { background: #fff; padding: 5px 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px;}
        .axis-input input { width: 60px; padding: 5px; text-align: center; font-weight: bold; }

        /* --- 拽专 砖驻专 --- */
        .custom-legend {
            display: flex; 
            justify-content: center; 
            gap: 30px; 
            margin-top: 15px; 
            padding-bottom: 10px;
            font-size: 15px;
            font-weight: 500;
        }
        .legend-item { display: flex; align-items: center; cursor: pointer; user-select: none; }
        .symbol-rain { width: 16px; height: 16px; background: rgba(54, 162, 235, 0.7); border: 1px solid blue; margin-left: 8px; }
        .symbol-line { width: 24px; height: 4px; background: #e74c3c; display: flex; align-items: center; justify-content: center; margin-left: 8px; position: relative;}
        .symbol-temp-dot { width: 12px; height: 12px; background: #fff; border: 3px solid #e74c3c; border-radius: 50%; position: absolute; }

        /* 驻转专 注专 爪祝 */
        #editModeBtn {
            display: none; position: fixed; bottom: 20px; right: 20px;
            background: #fff; padding: 10px 15px; border-radius: 30px; cursor: pointer; border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); font-weight: bold; color: #333;
            z-index: 999;
        }
        #editModeBtn:hover { background: #f0f0f0; }
    </style>
</head>
<body>

<div class="main-container">
    
    <div class="controls-bar editor-only">
        <div style="font-size: 18px;">
            <label><input type="checkbox" id="compareModeCheck" onchange="toggleCompareMode()" style="transform: scale(1.3); margin-left: 5px;"> <strong>爪 砖 (砖 拽转)</strong></label>
        </div>
        <div class="axis-input">
            <label> 拽住 爪专 砖: </label>
            <input type="number" id="maxRainInput" placeholder="'" onchange="updateCharts()">
            <span style="font-size: 12px; color: #666; display: block;">(砖专 专拽 住专  砖)</span>
        </div>
        <button class="action-btn" onclick="generateAndSave()"> 砖专 爪专 拽砖专 注</button>
    </div>

    <div class="charts-row">
        <div class="chart-box">
            <div class="header-section">
                <input type="text" id="name1" placeholder="砖 拽 专砖" oninput="updateTitles()">
                <div class="subtitle" id="sub1">爪注 砖拽注: 0 "</div>
            </div>
            <div class="chart-wrapper">
                <canvas id="chart1"></canvas>
            </div>
        </div>

        <div class="chart-box" id="box2" style="display:none;">
            <div class="header-section">
                <input type="text" id="name2" placeholder="砖 拽 砖" oninput="updateTitles()">
                <div class="subtitle" id="sub2">爪注 砖拽注: 0 "</div>
            </div>
            <div class="chart-wrapper">
                <canvas id="chart2"></canvas>
            </div>
        </div>
    </div>

    <div class="custom-legend">
        <div class="legend-item">
            <div class="symbol-rain"></div><span>砖拽注 (")</span>
        </div>
        <div class="legend-item">
            <div class="symbol-line"><div class="symbol-temp-dot"></div></div><span>驻专专 (C掳)</span>
        </div>
    </div>

    <div class="tables-container editor-only">
        
        <div class="editor-only" style="text-align: right; margin-bottom: 10px; color: #555;">
             驻: 注转拽 砖专 砖 拽住, 注 注 转 砖 <strong>专</strong> 抓 Ctrl+V.
        </div>

        <div class="table-box">
            <h3 style="margin-top:0; color:#2980b9;">注专转 转: 拽 专砖 ()</h3>
            <table id="table1"></table>
        </div>

        <div class="table-box" id="tableBox2" style="display:none;">
            <h3 style="margin-top:0; color:#2980b9;">注专转 转: 拽 砖 (砖)</h3>
            <table id="table2"></table>
        </div>
    </div>

</div>

<div id="editModeBtn" onclick="toggleEditMode()">锔 注专转 转</div>

<script>
    let chartInstance1 = null;
    let chartInstance2 = null;
    const months = ['', '驻专', '专抓', '驻专', '', '', '', '', '住驻', '拽', '', '爪'];

    const defaultData = {
        name: "转 ",
        rain: [130, 110, 70, 20, 5, 0, 0, 0, 1, 25, 80, 110],
        temp: [12, 13, 15, 19, 23, 26, 28, 29, 27, 24, 18, 14]
    };

    function initTable(tableId, suffix) {
        const table = document.getElementById(tableId);
        let headerHTML = '<thead><tr><th style="width:80px;">转</th>';
        months.forEach(m => headerHTML += `<th>${m}</th>`);
        headerHTML += '</tr></thead><tbody>';

        headerHTML += `<tr><td style="background:#eef; font-weight:bold; color:blue;">砖拽注</td>`;
        for(let i=0; i<12; i++) {
            headerHTML += `<td><input type="number" class="rain${suffix}" onpaste="handlePaste(event, 'rain${suffix}', ${i})" oninput="updateCharts()"></td>`;
        }
        headerHTML += '</tr>';

        headerHTML += `<tr><td style="background:#ffe; font-weight:bold; color:red;">驻'</td>`;
        for(let i=0; i<12; i++) {
            headerHTML += `<td><input type="number" class="temp${suffix}" onpaste="handlePaste(event, 'temp${suffix}', ${i})" oninput="updateCharts()"></td>`;
        }
        headerHTML += '</tr></tbody>';
        table.innerHTML = headerHTML;
    }

    function handlePaste(e, className, startIndex) {
        e.preventDefault();
        const clipboardData = e.clipboardData || window.clipboardData;
        const pastedData = clipboardData.getData('Text');
        const values = pastedData.split(/[\t\s,]+/).filter(v => v.trim() !== '');
        const inputs = document.querySelectorAll('.' + className);
        values.forEach((val, i) => {
            const index = startIndex + i;
            if (index < inputs.length && !isNaN(parseFloat(val))) {
                inputs[index].value = parseFloat(val);
            }
        });
        updateCharts();
    }

    function toggleCompareMode() {
        const isCompare = document.getElementById('compareModeCheck').checked;
        document.getElementById('box2').style.display = isCompare ? 'block' : 'none';
        document.getElementById('tableBox2').style.display = isCompare ? 'block' : 'none';
        updateCharts();
    }

    function getInputs(suffix) {
        const rainInputs = document.querySelectorAll('.rain' + suffix);
        const tempInputs = document.querySelectorAll('.temp' + suffix);
        return {
            rain: Array.from(rainInputs).map(i => parseFloat(i.value) || 0),
            temp: Array.from(tempInputs).map(i => parseFloat(i.value) || 0)
        };
    }

    function setInputs(suffix, rainData, tempData) {
        const rainInputs = document.querySelectorAll('.rain' + suffix);
        const tempInputs = document.querySelectorAll('.temp' + suffix);
        rainInputs.forEach((inp, i) => { if(rainData[i] !== undefined) inp.value = rainData[i]; });
        tempInputs.forEach((inp, i) => { if(tempData[i] !== undefined) inp.value = tempData[i]; });
    }

    function createChart(ctxId, rainData, tempData, yMax) {
        const ctx = document.getElementById(ctxId).getContext('2d');
        
        return new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [
                    {
                        label: '砖拽注',
                        data: rainData,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'blue',
                        borderWidth: 1,
                        yAxisID: 'y',
                        order: 2,
                        barPercentage: 0.6
                    },
                    {
                        label: '驻专专',
                        data: tempData,
                        type: 'line',
                        borderColor: '#e74c3c',
                        backgroundColor: '#e74c3c',
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#e74c3c',
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.2,
                        yAxisID: 'y1',
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, title: { display: false } },
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        max: yMax,
                        beginAtZero: true,
                        title: { 
                            display: true, 
                            text: '砖拽注 (")',
                            color: '#333',
                            font: { weight: 'bold', size: 14 }
                        }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        title: { 
                            display: true, 
                            text: '驻专专 (C掳)',
                            color: '#333',
                            font: { weight: 'bold', size: 14 }
                        }
                    }
                }
            }
        });
    }

    function updateCharts() {
        const data1 = getInputs('1');
        const data2 = getInputs('2');
        
        // 注 转专转 砖
        const sum1 = data1.rain.reduce((a,b)=>a+b, 0);
        const sum2 = data2.rain.reduce((a,b)=>a+b, 0);
        document.getElementById('sub1').innerText = `爪注 砖拽注: ${Math.round(sum1)} "`;
        document.getElementById('sub2').innerText = `爪注 砖拽注: ${Math.round(sum2)} "`;

        // === 砖 住拽 (驻爪'专 砖) ===
        let yMax = null;
        const userMax = document.getElementById('maxRainInput').value;

        if (userMax) {
            //  砖转砖  转 - 砖转砖 
            yMax = parseFloat(userMax);
        } else if (document.getElementById('compareModeCheck').checked) {
            //  爪 砖 + 砖 专拽 -> 砖  砖 拽住 砖转祝
            const max1 = Math.max(...data1.rain);
            const max2 = Math.max(...data2.rain);
            const absoluteMax = Math.max(max1, max2);
            // 注 驻 驻 注 (砖 -10 拽专)
            yMax = Math.ceil((absoluteMax + 5) / 10) * 10;
        }

        // 爪专转 专驻 注 -yMax 砖
        if (chartInstance1) chartInstance1.destroy();
        chartInstance1 = createChart('chart1', data1.rain, data1.temp, yMax);

        if (document.getElementById('compareModeCheck').checked) {
            if (chartInstance2) chartInstance2.destroy();
            chartInstance2 = createChart('chart2', data2.rain, data2.temp, yMax);
        }
    }

    function updateTitles() {}

    function generateAndSave() {
        const name1 = document.getElementById('name1').value;
        const data1 = getInputs('1');
        
        const isCompare = document.getElementById('compareModeCheck').checked;
        const name2 = document.getElementById('name2').value;
        const data2 = getInputs('2');
        
        const ymax = document.getElementById('maxRainInput').value;

        let newUrl = `${window.location.pathname}?view=clean&n1=${encodeURIComponent(name1)}&r1=${data1.rain}&t1=${data1.temp}`;
        
        if (isCompare) {
            newUrl += `&compare=1&n2=${encodeURIComponent(name2)}&r2=${data2.rain}&t2=${data2.temp}`;
        }
        if (ymax) newUrl += `&ymax=${ymax}`;

        window.history.pushState({path: newUrl}, '', newUrl);
        
        document.body.classList.add('clean-mode');
        document.getElementById('editModeBtn').style.display = 'block';
    }

    function toggleEditMode() {
        document.body.classList.remove('clean-mode');
        document.getElementById('editModeBtn').style.display = 'none';
        const params = new URLSearchParams(window.location.search);
        params.delete('view');
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        window.history.pushState({path: newUrl}, '', newUrl);
    }

    window.onload = function() {
        initTable('table1', '1');
        initTable('table2', '2');

        const params = new URLSearchParams(window.location.search);
        
        if (params.has('name') && !params.has('n1')) {
            document.getElementById('name1').value = decodeURIComponent(params.get('name'));
            setInputs('1', params.get('rain').split(',').map(Number), params.get('temp').split(',').map(Number));
        } else if (params.has('n1')) {
            document.getElementById('name1').value = decodeURIComponent(params.get('n1'));
            setInputs('1', params.get('r1').split(',').map(Number), params.get('t1').split(',').map(Number));
        } else {
            setInputs('1', defaultData.rain, defaultData.temp);
            document.getElementById('name1').value = defaultData.name;
        }

        if (params.get('compare') === '1') {
            document.getElementById('compareModeCheck').checked = true;
            document.getElementById('name2').value = decodeURIComponent(params.get('n2'));
            setInputs('2', params.get('r2').split(',').map(Number), params.get('t2').split(',').map(Number));
            toggleCompareMode();
        }

        if (params.has('ymax')) {
            document.getElementById('maxRainInput').value = params.get('ymax');
        }

        if (params.get('view') === 'clean') {
            document.body.classList.add('clean-mode');
            document.getElementById('editModeBtn').style.display = 'block';
        }
        
        updateCharts();
    };
</script>

</body>
</html>
